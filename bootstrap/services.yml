parameters:
    commands: # Application CommandLoader: lazy-load commands
        create: Cinch\Console\CreateProjectCommand

services:
    _defaults:
        autowire: true
        public: false

    _instanceof:
        Cinch\Console\AbstractCommand:
            public: true
            calls:
                -   setLogger: [ '@logger' ]
                -   setProjectDir: [ '%project.dir%' ]
                -   setEnvironment: [ '%env_name%' ]
        Symfony\Component\EventDispatcher\EventSubscriberInterface:
            tags: [ 'subscriber' ]

    Cinch\:
        lazy: true
        resource: '../src'
        exclude: [ '../src/helpers.php' ]

    Cinch\Console\Application:
        public: true
        arguments:
            $version: '%cinch.version%'

    # log.file points to a temp file during create. inject path, so it can be moved to projectDir after create
    Cinch\Console\CreateProjectCommand:
        arguments:
            $tempLogFile: '%log.file%'

    log.time_zone:
        class: DateTimeZone
        arguments:
            - '%log.time_zone%'

    log.formatter:
        class: Monolog\Formatter\LineFormatter
        arguments:
            $dateFormat: 'Y-m-d\TH:i:sO'
            $ignoreEmptyContextAndExtra: true

    log.stream_handler:
        public: true
        class: Monolog\Handler\StreamHandler
        arguments:
            $stream: '%log.file%'
        calls:
            -   setFormatter: [ '@log.formatter' ]

    log.noop_handler:
        public: true
        class: Monolog\Handler\NoopHandler

    logger:
        class: Monolog\Logger
        arguments:
            $name: '%project.name%'
            $handlers:
                - "@=parameter('log.enabled') ? service('log.stream_handler') : service('log.noop_handler')"
            $timezone: '@log.time_zone'

    Psr\Log\LoggerInterface: '@logger'

    Cinch\Console\ConsoleProjectRepository: ~
    Cinch\Project\ProjectRepository: '@Cinch\Console\ConsoleProjectRepository'

    Cinch\History\SchemaVersion:
        arguments:
            - '%schema.version%'
            - '%schema.description%'
            - '%schema.release_date%'

    Cinch\Services\DataStoreFactory:
        arguments:
            $application: 'Cinch CLI %cinch.version%'

    Cinch\MigrationStore\XXH128MigrationFactory: ~
    Cinch\MigrationStore\MigrationFactory: '@Cinch\MigrationStore\XXH128MigrationFactory'

    Cinch\MigrationStore\MigrationStoreFactory:
        arguments:
            $projectDir: '%project.dir%'
            $resourceDir: '%cinch.resource_dir%'
            $userAgent: 'cinch-cli/%cinch.version%'

    Twig\Loader\LoaderInterface:
        class: Twig\Loader\FilesystemLoader
        arguments:
            - '%twig.template_dir%'

    Twig\Environment:
        arguments:
            $options:
                autoescape: false
                strict_variables: true
                auto_reload: '%twig.auto_reload%'
                debug: '%twig.debug%'
