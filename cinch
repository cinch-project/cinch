#!/usr/bin/env php
<?php

use Cinch\Console\Application;
use Cinch\Console\ConsoleIo;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Dotenv\Dotenv;

require_once __DIR__ . '/vendor/autoload.php';

if (PHP_SAPI !== 'cli')
    throw new RuntimeException("cinch CLI only supports 'cli' SAPI");

$io = new ConsoleIo($output = new ConsoleOutput());
$application = new Application('cinch', $io);
$application->configureIO($input = new ArgvInput(), $output);

try {
    $appRoot = __DIR__;
    $dotEnv = (new Dotenv())->usePutenv();

    if (($env = getenv('CINCH_ENV')) !== false && $env != 'local' && $env != 'prod')
        $env = false;

    if (!$env) {
        /* prod builds do not include .env.local. So if local exists, use it. */
        $env = file_exists("$appRoot/.env.local") ? 'local' : 'prod';
        $dotEnv->populate(['CINCH_ENV' => $env], overrideExistingVars: true);
    }

    $dotEnv->load("$appRoot/.env.$env");
    $version = getenv('CINCH_VERSION');
    $io->debug("cinch $version using $env environment");

    $application->setAutoExit(false);
    $application->setVersion($version);
    $exitCode = $application->run($input, $output);
}
catch (Exception $e) {
    $exitCode = 255;
    $application->renderThrowable($e, $output->getErrorOutput());
}

if ($exitCode = min(255, $exitCode))
    $io->debug("application exit code $exitCode");

exit($exitCode);