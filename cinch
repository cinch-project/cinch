#!/usr/bin/env php
<?php

use Cinch\Console\Application;
use Symfony\Component\Console\Formatter\OutputFormatterStyle;
use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Dotenv\Dotenv;

require_once __DIR__ . '/vendor/autoload.php';

if (PHP_SAPI !== 'cli')
    throw new RuntimeException("cinch CLI only supports 'cli' SAPI");

$application = new Application('cinch');
$output = new ConsoleOutput();
$output->getFormatter()->setStyle('code-comment', new OutputFormatterStyle('gray'));
$output->getFormatter()->setStyle('code', new OutputFormatterStyle('blue'));

try {
    $appRoot = __DIR__;
    $dotEnv = (new Dotenv())->usePutenv();

    if (($env = getenv('CINCH_ENV')) !== false && $env != 'local' && $env != 'prod')
        $env = false;

    if (!$env) {
        /* prod builds do not include .env.local. So if local exists, use it. */
        $env = file_exists("$appRoot/.env.local") ? 'local' : 'prod';
        $dotEnv->populate(['CINCH_ENV' => $env], overrideExistingVars: true);
    }

    $dotEnv->load("$appRoot/.env.$env");

    $application->setAutoExit(false);
    $application->setVersion(getenv('CINCH_VERSION'));
    $exitCode = $application->run(output: $output);
}
catch (Exception $e) {
    $exitCode = 255;
    $application->renderThrowable($e, $output->getErrorOutput());
}

if ($exitCode = min(255, $exitCode))
    $output->writeln("<code>[application exit code $exitCode]</>");

exit($exitCode);